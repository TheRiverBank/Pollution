---
title: "Energy"
author: "Sondre Løvås"
date: "26 11 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(lubridate)
library(zoo)
library(scales)
library(reshape2)
library(ggplot2)
library(gridExtra)
library(maps)
```

```{r data, include=FALSE}
emision_by_sector <- read.csv("data/ghg-emissions-by-sector.csv", stringsAsFactors = FALSE)
primary_energy_sources <- read.csv("data/primary-energy-consumption-by-source.csv", stringsAsFactors = FALSE)
global_primary_energy <- read.csv("data/global-primary-energy.csv", stringsAsFactors = FALSE)
global_temp_anomaly <- read.csv("data/temperature-anomaly.csv", stringsAsFactors = FALSE, skip = 4)
global_co_emission <- read.csv("data/annual-co-emissions-by-region.csv")
ambient_air_pollution_deaths <- read.csv("data/ambient-air-pollution-deaths.csv", stringsAsFactors = FALSE, skip = 2)
natural_disasters_by_type <- read.csv("data/natural-disasters-by-type.csv", stringsAsFactors = FALSE)
sea_level_rise <- read.csv("data/sea-level-rise.csv", stringsAsFactors = FALSE, skip = 5)
ice_amount <-read.csv("data/ice-amount.csv", stringsAsFactors = FALSE)
renewable_energy_investment <- read.csv("data/renewable-energy-investment.csv", stringsAsFactors = FALSE)
electric_car_sales <- read.csv("data/global-electric-car-sales-by-key-markets-2010-2020.csv", stringsAsFactors = FALSE, skip = 3)
```

```{r include=FALSE}
emision_summarized <- emision_by_sector %>%
  group_by(Year) %>%
  summarise_at(vars(Agriculture..GHG.Emissions..CAIT.:Transport..GHG.Emissions..CAIT.), sum, na.rm=TRUE)

df_emission_by_sector <- melt(emision_summarized, id.vars = c("Year")) %>%
  mutate(variable =
           recode(variable,
                  "Agriculture..GHG.Emissions..CAIT."="Agriculture",
                  "Bunker.Fuels..GHG.Emissions..CAIT."="Shipping",
                  "Industry..GHG.Emissions..CAIT."="Industry",
                  "Land.Use.Change.and.Forestry..GHG.Emissions..CAIT."="Land-Use Change and Forestry",
                  "Waste..GHG.Emissions..CAIT."="Waste",
                  "Buildings..GHG.Emissions..CAIT."="Buildings",
                  "Electricity...Heat..GHG.Emissions..CAIT."="Electricity and Heat",
                  "Fugitive.from.energy.production..GHG.Emissions..CAIT."="Fugitive",
                  "Manufacturing.Construction.energy..GHG.Emissions..CAIT."="Manufacturing and Construction",
                  "Other.Fuel.Combustion..GHG.Emissions..CAIT."="Other fuel combustion",
                  "Transport..GHG.Emissions..CAIT."="Transport"))

total_emission_2016 <- df_emission_by_sector %>%
  filter(Year==2016) %>%
  summarize(Totlal_Emission=sum(value, na.rm = TRUE))

total_electricity_2016 <- df_emission_by_sector %>%
  filter(Year==2016 & variable=="Electricity and Heat") %>%
  summarize(Total_Electricity=sum(value, na.rm = TRUE))
```

```{r globalEnergySources, include=FALSE}
df_global_primary_energy <- melt(global_primary_energy, id.vars = "Year") %>% # Melt data frame such that all sources are in one column.
  filter(Year >= 1965) %>%
  mutate(variable =
           recode(variable,
                  "Coal..TWh..direct.energy."="Coal",
                  "Oil..TWh..direct.energy."="Oil",
                  "Gas..TWh..direct.energy." = "Gas",
                  "Hydropower..TWh..direct.energy."="Hydropower",
                  "Nuclear..TWh..direct.energy."="Nuclear",
                  "Solar..TWh..direct.energy."="Solar",
                  "Other.renewables..TWh..direct.energy."="Other renewables",
                  "Traditional.biomass..TWh..direct.energy."="Biomass",
                  "Wind..TWh..direct.energy."="Wind",
                  "Biofuels..TWh..direct.energy." = "Biofuels")
         )

# Extract the nonrenewable sources.
df_global_primary_nonrenew <- df_global_primary_energy %>%
  filter(variable == c("Coal", "Oil", "Gas"))

# Extract renewable sources.
df_global_primary_renew <- df_global_primary_energy %>%
  filter(variable == c("Hydropower", "Solar", "nuclear"," Other renewables", "Wind"))
```

```{r renewableEnergyInvestment, include=FALSE}
df_renewable_investment <- renewable_energy_investment %>%
  group_by(Entity) %>%
  rename("Investment"="Investment.in.Renewables.by.Region..IRENA..2016..")
```

```{r globalTempAnomaly, include=FALSE}
df_global_temp_anomaly <- global_temp_anomaly %>%
  mutate(Value = replace(Value, Value == -999, NA)) # NA values are represented as -999 in original dataset. 
```

```{r gloablCoEmission, include=FALSE}
df_global_co_emission <- global_co_emission %>%
  filter(Entity=="World" & Year >= 1880) %>%
  group_by(Year) %>%
  summarize(Sum_Year=sum(Annual.CO2.emissions))
```

```{r ambientAirPollutionDeaths, include=FALSE}
# Variables are represented in the form: median [range].
pollution_deaths_2016 <- ambient_air_pollution_deaths %>%
  filter(Cause=="Total") %>%
  mutate(Both.sexes=as.numeric(gsub("([0-9]+) .*", "\\1", Both.sexes))) %>% # Only want median value.
  summarise(Sum_Deaths=sum(Both.sexes, na.rm = TRUE))
```

```{r naturalDisaters, include=FALSE}
df_natural_disasters <- natural_disasters_by_type %>%
  filter(Entity==c("Wildfire", "Drought", "Extreme temperature", "Flood")) %>%
  rename("Num_Disasters"=Number.of.disasters..EMDAT..2020..)
```

```{r globalSeaLevel}
df_sea_level_rise <- melt(sea_level_rise, id.vars = "year") %>%
  drop_na() 
 
ave_sea_level_rise <- df_sea_level_rise %>%
  summarise(avg_change = mean(c(NA, diff(value)), na.rm = TRUE)) %>%
  mutate(name="TEST")
ave_sea_level_rise
```

```{r regionalSeaLevelScrape, eval=FALSE, include=FALSE}
# Scrape sea level data. 
# This chuck will download sea data from https://www.star.nesdis.noaa.gov/socd/lsa/SeaLevelRise/LSA_SLR_timeseries.php,
# and is set to not run. The data up until December 2020 is already found in the 'regional sea level' folder.
# If more recent data is wanted, set eval to true.
sea_level_URL <- "https://www.star.nesdis.noaa.gov/socd/lsa/SeaLevelRise/LSA_SLR_timeseries.php"
sea_URL_short <- "https://www.star.nesdis.noaa.gov/socd/lsa/SeaLevelRise/"
webpage <- read_html(sea_level_URL)

j <- 0
#Scrape csv file names and download them.
for (i in 4:27) {
  ocean_name_node <- sprintf("#list2 tr:nth-child(%s) th", i)
  ocean_name <- webpage %>% html_nodes(ocean_name_node) %>% html_text()
  ocean_name_nospace <- gsub(" ", "-", ocean_name)
  file_node<- sprintf("#list2 tr:nth-child(%s) th+ td a:nth-child(1)", i)
  file_name <- webpage %>% html_nodes(file_node) %>% html_attr("href")
  file_URL <- paste(sea_URL_short, file_name, sep="")
  dest <- paste("data/regional-sea-level/", ocean_name_nospace, ".csv", sep="")
  download.file(url=file_URL, destfile = dest)
}
```


```{r wrangleRegionalSeaLevelData}
# Get average change in selected oceans.
oceans <- c("Pacific-Ocean", "Atlantic-Ocean", "Indian-Ocean", "Southern-Ocean", "North-Sea")
lo <- c(-5, -14, -25, -68, 56)
la <- c(-140, -19, 79, -160, 3) 

df_regional_sea_average <- NULL
i <- 0
for (ocean in oceans) {
  file_path <- paste("data/regional-sea-level/", ocean, ".csv", sep="")
  file <- read.csv(file_path, stringsAsFactors = FALSE, skip = 5)
  average_sea_level_change <- melt(file, id.vars = "year") %>%
    summarise(Average_Change = mean(c(NA, diff(value)), na.rm=TRUE))
  if (is.null(df_regional_sea_average)) {
    df_regional_sea_average <- data.frame(Ocean=ocean, Average_change=average_sea_level_change)
  } else {
    df_temp <- data.frame(Ocean=ocean, Average_change=average_sea_level_change)
    df_regional_sea_average <-  rbind(df_regional_sea_average, df_temp)
  }
}
test_change <- c(1,2,3,4,5)
test <- cbind(df_regional_sea_average, lo, la, test_change)

test
```


```{r}
df_arctic_sea_ice <- ice_amount %>%
  select(c(year, extent))

mean_ice_melt <- df_arctic_sea_ice %>%
  summarise(avg_change = mean(c(NA, diff(extent)), na.rm = TRUE))
mean_ice_melt
```

```{r include=FALSE}
electric_car_sales
electric_car_sales <- electric_car_sales %>%
  select(c("X", "Market.Share"))

df_electric_car_sales <- melt(electric_car_sales, id.vars = "X") %>%
  rename("Year"="X") %>%
  filter(Year < 2020) %>%
  group_by(Year) %>%
  summarize(Sum_Market_Share=sum(value, na.rm=TRUE))

df_electric_car_sales
```


```{r plotAstetics, include=FALSE}
pltTheme <- theme_light() + theme(plot.title = element_text(hjust = 0.5))
```


In this project, pollution is discussed with an emphasis on air pollution.
I will look at the main causes of pollution and the steps that are being taken to decrease the amount of toxic gases that are being released. 
Human 

<!-- The bad -->

This plot shows how many million tonnes of greenhouse gasses that were released from 1990-2016, measured in the equivalent amount of carbon dioxide that would produce that same amount of energy.
```{r echo=FALSE, fig.width=10}
ggplot(df_emission_by_sector, aes(Year, value, col=variable)) + 
  labs(y="Million tonnes", title="Emission by sector in million tonnes carbon dioxide-equivalents", colour="Sector") +
  pltTheme +
  geom_line()
```
Electricity seems to be a big contributor to greenhouse gases. Of the `r format(round(total_emission_2016), big.mark=",",scientific=FALSE)` tonnes of greenhouse gases, electricity and heat makes out to be `r format(round((total_electricity_2016/total_emission_2016)*100))`% of the total emission.

Let's look at the primary sources of energy the world consumes. This will include energy used by the different sectors in the previous graph. 
```{r echo=FALSE, fig.width=14}
ggplot(df_global_primary_energy, aes(Year, value, col=variable)) + 
  labs(y="TWh", title="Global primary energy sources.", colour="Source") +
  pltTheme +
  geom_line()
```
As expected, coal, oil and gas are the worlds primary energy sources. The next visualization tries to emphasize in a higher degree.

```{r echo=FALSE}
ggplot(df_global_primary_energy, aes(Year, value, fill=variable)) + 
  labs(y="TWh", title="Global primary energy sources.", colour="Source") +
  pltTheme +
  geom_area(position = "stack") 
```

The use of nonrenewable energy, and the greenhouse gases it emits, correlates to rising temperatures across the world. 
Under is a visualization of rising temperatures and the amount of carbon dioxide emitted from fossil fuels. 

```{r echo=FALSE, fig.width=14, fig.width=10}
plt_emission <- ggplot(df_global_co_emission, aes(x=Year, y=Sum_Year)) +
  geom_line(color="red") +
  labs(y="Co2 emission in milion tonnes") +
  pltTheme

plt_temperature <- ggplot(df_global_temp_anomaly, aes(x=Year, y=Value)) +
  geom_line(color="blue") +
  labs(y="Temperature") +
  pltTheme

grid.arrange(plt_emission, plt_temperature, nrow=2)
```
There is a `r format(round(cor(df_global_co_emission$Sum_Year, df_global_temp_anomaly$Value[0:139]), 2), nsmall=2)` correlation between these two variables.

Furthermore, ambient air pollution which is pollution from motor vehicles, oil and coal power plants, oil refineries etc. has resulted in `r format(pollution_deaths_2016,big.mark=",",scientific=FALSE)` deaths across the globe in 2016$^{[1][2]}$. Research has also suggested that greenhouse gases has increased the  frequency of natural disasters like hurricanes, floods, storms, droughts and wildfires$^{3}$.
```{r echo=FALSE, fig.width=10}
ggplot(df_natural_disasters, aes(x=Year, y=Num_Disasters, color=Entity)) +
  labs(y="Value", title="Number of natural disasters.") +
  geom_col() +
  pltTheme +
  theme(legend.position = "none") +
  facet_wrap(~Entity, scales = "free_y")
```
https://ourworldindata.org/natural-disasters

Floods could be linked to rising sea levels which again is caused by melting ice on the arctics.
This plot shows the rate at which ice is depleting.
```{r}
ggplot(df_arctic_sea_ice, aes(x=year, y=extent)) +
  labs(y="Million square km") +
  pltTheme +
  geom_line()
```
https://climate.nasa.gov/vital-signs/arctic-sea-ice/ 

And here it is shown the rise in water levels
```{r}
ggplot(df_sea_level_rise, aes(x=year, y=value, colour=variable)) +
  labs(y="Change in water levels") +
  geom_line()
```

```{r fig.width=14}
p <- ggplot() + coord_fixed() +
  xlab("") + ylab("")
world_map <- map_data("world")
base_world_messy <- p + geom_polygon(data=world_map, aes(x=long, y=lat, group=group), 
                                    fill="lightblue") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = 'white', colour = 'white'), 
        axis.line = element_line(colour = "white"),
        axis.ticks=element_blank(), axis.text.x=element_blank(),
        axis.text.y=element_blank())

base_world <- base_world_messy + 
  geom_point(data=test, aes(x=la, y=lo, fill=Ocean), size=abs(test$Average_Change*100), pch=21, alpha=I(0.3)) +
  labs(colour="Ocean")
  

base_world
```


<!-- The good -->

Dividing the renewable sources from the nonrenewable sources, it can bee seen that renewable energy has been on a heavy rise since around 2005. 
```{r plotNonVsRenew, echo=FALSE, fig.width=14}
plt_renew <- ggplot(df_global_primary_renew, aes(Year, value, col=variable)) + 
  labs(y="TWh", title="comsumption of renewable energy.", colour="Renewable sources") + 
  pltTheme +
  geom_line()

plt_nonrenew <- ggplot(df_global_primary_nonrenew, aes(Year, value, col=variable)) +
  labs(y="TWh", title="Consumption of nonrenewable energy.", color="Nonrenewable sources") +
  pltTheme +
  geom_line()

gridExtra::grid.arrange(plt_renew, plt_nonrenew, ncol=2)
```

This is partly an effect of greater investment in renewable energy sources.
```{r echo=FALSE, fig.width=14}
ggplot(df_renewable_investment, aes(x=Year, y=Investment, colour=Entity)) + 
  labs(y="Investment in billion USD.") +
  pltTheme +
  geom_line()
```

Returning to emissions by sector, it can be seen that transport is the next highest source of carbon dioxide-equivalent emission. Progress has been made towards shifting to electric, as the sales of electric cars rise every year. Due to environmental reasons, driving an electric car has been given a lot of benefits. In Norway the price of charging an electric car versus using fossil fuel favors the electric car heavily when it comes to cost. Also, taxes and insurance comes cheaper with an electric car.

```{r fig.width=10}
ggplot(df_electric_car_sales, aes(x=Year, y=Sum_Market_Share/100)) +
  pltTheme +
  scale_y_continuous(labels=percent) +
  scale_x_continuous(breaks=seq(2010, 2019, 1)) +
  labs(y="Market share", title="Electric car market share.") +
  geom_col()
```
IEA, Global electric car sales by key markets, 2010-2020, IEA, Paris https://www.iea.org/data-and-statistics/charts/global-electric-car-sales-by-key-markets-2015-2020

Sources:
Global temperature anomaly
https://www.ncdc.noaa.gov/cag/global/time-series/globe/land_ocean/ytd/12/1880-2019
[1].https://www.who.int/airpollution/ambient/pollutants/en/ WHO Ambient air pollution
[2].https://apps.who.int/gho/data/node.main.BODAMBIENTAIRDTHS?lang=en WHO Deaths caused by ambient air pollution
[3].Anderson, Jason, and Camilla Bausch. "Climate Change and Natural Disasters: Scientific evidence of a possible relation between recent natural disasters and climate change." Policy Department Economic and Scientific Policy 2 (2006). 